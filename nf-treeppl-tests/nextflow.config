params {
    outdir = "test_output"
    simdir = "${params.outdir}/sims"
    analysisdir = "${params.outdir}/analysis"
    datadir = "${params.outdir}/data"
    bindir = "${params.outdir}/bins"
    publish_dir_mode = 'copy'
    time = false
    ngens = null
    nruns = null
    niter = 100000
    compile_flags = "compile_flags.csv"
    models = "models.csv"
    container_treeppl = "danielssonerik/treeppl:custom-drift-kernels"
    container_revbayes = "sswiston/phylo_docker:slim_amd64"
    container_r = "danielssonerik/host-repertoire-treeppl:r-base-pak"  
    container_python = "danielssonerik/python-mcmc-tests:latest"
    container_base = "ubuntu:22.04"
}

profiles {
    docker {
        docker.enabled    = true
        apptainer.enabled = false
        podman.enabled = false
    }

    apptainer {
        docker.enabled    = false
        apptainer.enabled = true
        podman.enabled = false
    }

    podman {
        docker.enabled    = false
        apptainer.enabled = false
        podman.enabled = true
    }
    no_freeze {
        executor.memory = 10.GB
        executor.cpus = 6
    }
}



process {

    container = params.container_base    

    cpus = 1

    publishDir = [
        path: { "${params.outdir}/${task.process.toLowerCase()}" },
        mode: params.publish_dir_mode,
    ]

    errorStrategy = { task.exitStatus in ((130..145) + 104) ? 'retry' : 'finish' }
    maxRetries    = 5
    memory = { 1.5.GB * Math.pow(2, task.attempt - 1) }

    withLabel:data {
        publishDir = [
            path: { "${params.datadir}/${task.process.toLowerCase()}" },
            mode: params.publish_dir_mode,
        ]
    }

    withLabel:compile {
        publishDir = [
            path: { "${params.bindir}/${task.process.toLowerCase()}" },
            mode: params.publish_dir_mode,
        ]
        memory = 2.GB
    }

    withLabel:sim {
        publishDir = [
            path: { "${params.simdir}/${task.process.toLowerCase()}" },
            mode: params.publish_dir_mode,
        ]
        memory = { 1.5.GB * Math.pow(2, task.attempt - 1) }
        maxRetries    = 5
    }

    withLabel:analysis {
        publishDir = [
            path: { "${params.analysisdir}/${task.process.toLowerCase()}" },
            mode: params.publish_dir_mode,
        ]
        memory = { 1.5.GB * Math.pow(2, task.attempt - 1) }
        maxRetries    = 5
    }
}